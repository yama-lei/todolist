"use strict";(self["webpackChunkzhiyuxinsheng"]=self["webpackChunkzhiyuxinsheng"]||[]).push([[848],{503:function(e,a,t){t.d(a,{c:function(){return s}});var l=t(2261);t(4300);const s=(0,l.nY)("currency",{state:()=>({coins:parseInt(localStorage.getItem("coins")||"100"),loading:!1}),actions:{addCoins(e){this.coins+=e,this.saveCoins()},deductCoins(e){return this.coins>=e&&(this.coins-=e,this.saveCoins(),!0)},saveCoins(){localStorage.setItem("coins",this.coins.toString())},resetCoins(){this.coins=100,this.saveCoins()}}})},2333:function(e,a,t){t.d(a,{O:function(){return c}});t(4114),t(8111),t(2489),t(116);var l=t(2261),s=t(144),r=t(6768),o=t(3271),n=t(4300),i=t(1219);const c=(0,l.nY)("task",(()=>{const e=(0,s.KR)([]),a=(0,s.KR)([]),t=(0,s.KR)([]),l=(0,s.KR)(!1),c=(0,r.EW)((()=>e.value.filter((e=>!e.completed)))),u=async()=>{try{l.value=!0;const a=await n.WY.getTasks();e.value=a.tasks.filter((e=>!e.completed)),t.value=a.tasks.filter((e=>e.completed))}catch(a){i.nk.error("获取任务列表失败")}finally{l.value=!1}},d=async()=>{try{l.value=!0;const e=await n.WY.getSystemTasks();a.value=e.tasks}catch(e){i.nk.error("获取系统任务失败")}finally{l.value=!1}},p=async a=>{try{const t=await n.WY.createTask({title:a.title,description:a.description||"",deadline:a.deadline||"",important:a.important||!1});e.value.push(t.task),i.nk.success("任务创建成功")}catch(t){i.nk.error("创建任务失败")}},v=async a=>{try{await n.WY.completeTask(a);const l=e.value.find((e=>e._id===a));l&&(t.value.unshift({...l,completed:!0,completedAt:(new Date).toISOString()}),e.value=e.value.filter((e=>e._id!==a)));const s=(0,o.g)();if(s.plants&&s.plants.length>0){const e=s.plants.find((e=>e.isMainPlant));if(e){const a=e._id||e.id;if(a){const e=l&&l.important?50:25;await s.gainExperience(a,e),i.nk.success(`任务已完成，获得 ${e} 点经验值！`)}}}else i.nk.success("任务已完成")}catch(l){i.nk.error("完成任务失败")}},f=async e=>{try{const t=(0,o.g)();if(!t.currentPlant)return i.nk.warning("请先添加一个植物"),!1;const l=await n.WY.completeSystemTask(e),s=a.value.findIndex((a=>a._id===e));if(-1!==s&&(a.value[s].completed=!0),l.rewards)i.nk.success(`完成任务获得 ${l.rewards.experience} 点经验`);else{const e=t.currentPlant._id||t.currentPlant.id;if(e){const a=35;await t.gainExperience(e,a),i.nk.success(`完成系统任务获得 ${a} 点经验值`)}}return!0}catch(t){return 400===t.response?.status?i.nk.warning("今天已经完成过此任务"):i.nk.error("完成系统任务失败"),!1}},k=async a=>{try{if(!a)return void i.nk.error("任务ID无效，无法删除");await n.WY.deleteTask(a),e.value=e.value.filter((e=>e._id!==a)),i.nk.success("任务已删除")}catch(t){console.error("删除任务失败:",t),i.nk.error("删除任务失败")}},m=async e=>{try{if(!e)return void i.nk.error("任务ID无效，无法删除");await n.WY.deleteTask(e),t.value=t.value.filter((a=>a._id!==e)),i.nk.success("任务已删除")}catch(a){console.error("删除任务失败:",a),i.nk.error("删除任务失败")}},g=async a=>{try{const{_id:t,title:l,description:s,deadline:r,important:o}=a,c=await n.WY.updateTask(t,{title:l,description:s,deadline:r,important:o}),u=e.value.findIndex((e=>e._id===t));-1!==u&&(e.value[u]=c.task),i.nk.success("任务已更新")}catch(t){i.nk.error("更新任务失败")}},b=async a=>{const t=e.value.find((e=>e._id===a));t&&await g({...t,important:!t.important})};return{tasks:e,systemTasks:a,completedTasks:t,pendingTasks:c,loading:l,fetchTasks:u,fetchSystemTasks:d,addTask:p,completeTask:v,completeSystemTask:f,removeTask:k,removeCompletedTask:m,updateTask:g,toggleTaskImportance:b}}))},5011:function(e,a,t){t(8111),t(1701);var l=t(4300),s=t(788),r=t.n(s);const o={getOSSConfig(){return l.Ay.get("/oss/config")},getOSSPolicy(e="posts/"){return l.Ay.get("/oss/policy",{params:{dir:e}})},async uploadFile(e,a="posts/"){try{const t=await this.getOSSPolicy(a),l=t.policy;if(!l)throw new Error("获取上传策略失败");let s=l.host;"object"===typeof s&&(console.error("Host 是一个对象而不是字符串:",s),s=`https://${l.bucket}.${l.region}.aliyuncs.com`),s.startsWith("http")||(s=`https://${s}`);const o=new FormData,n=`${l.key}${e.name.substring(e.name.lastIndexOf("."))}`;o.append("key",n),o.append("OSSAccessKeyId",l.accessKeyId),o.append("policy",l.policyBase64),o.append("signature",l.signature),o.append("success_action_status","200"),o.append("file",e),console.log("正在上传文件到:",s),await r().post(s,o,{headers:{"Content-Type":"multipart/form-data"}});let i=l.cdnHost||s;"object"===typeof i&&(i=s);const c=`${i}/${n}`;return console.log("文件上传成功，URL:",c),c}catch(t){throw console.error("上传文件到OSS失败:",t),t}},async uploadMultipleFiles(e,a="posts/"){if(!e||0===e.length)return[];try{const t=await this.getOSSPolicy(a),l=t.policy;if(!l)throw new Error("获取上传策略失败");let s=l.host;"object"===typeof s&&(console.error("Host 是一个对象而不是字符串:",s),s=`https://${l.bucket}.${l.region}.aliyuncs.com`),s.startsWith("http")||(s=`https://${s}`),console.log("准备批量上传文件到:",s);const o=e.map((async(a,t)=>{try{const o=new FormData,n=`${l.key}-${t}${a.name.substring(a.name.lastIndexOf("."))}`;o.append("key",n),o.append("OSSAccessKeyId",l.accessKeyId),o.append("policy",l.policyBase64),o.append("signature",l.signature),o.append("success_action_status","200"),o.append("file",a),await r().post(s,o,{headers:{"Content-Type":"multipart/form-data"}});let i=l.cdnHost||s;"object"===typeof i&&(i=s);const c=`${i}/${n}`;return console.log(`文件 ${t+1}/${e.length} 上传成功:`,c),c}catch(o){throw console.error(`文件 ${t+1}/${e.length} 上传失败:`,o),o}})),n=await Promise.all(o);return console.log("所有文件上传完成，URL列表:",n),n}catch(t){throw console.error("批量上传文件到OSS失败:",t),t}}};a.A=o},9848:function(e,a,t){t.r(a),t.d(a,{default:function(){return A}});var l=t(6768),s=t(144),r=t(4232),o=t(14),n=t(3271),i=t(2333),c=t(503),u=t(7477),d=t(1219),p=t(5320),v=t(5011);const f={class:"profile-page"},k={class:"profile-container"},m={class:"page-header"},g={key:1,class:"header-actions"},b={class:"profile-content"},y={class:"profile-sidebar"},h={class:"avatar-container"},w={key:1,class:"avatar-upload"},F={class:"avatar-upload-mask"},_={class:"avatar-options"},I={class:"avatar-section"},V={class:"default-avatars"},L=["onClick"],P={class:"avatar-section"},W={class:"username"},C={class:"user-level"},S={class:"sidebar-stats"},T={class:"stat-item"},$={class:"stat-value"},R={class:"stat-item"},Y={class:"stat-value"},K={class:"stat-item"},E={class:"stat-value"},U={class:"profile-details"},D={class:"form-section"};var x={__name:"Profile",setup(e){const a=(0,o.n)(),t=(0,n.g)(),x=(0,i.O)(),O=(0,c.c)(),M=(0,s.KR)(!1),A=(0,s.KR)(!1),z=(0,s.KR)({username:a.userInfo.username||"",email:a.userInfo.email||"",avatar:a.userInfo.avatar||"",bio:a.userInfo.bio||"",gender:a.userInfo.gender||"secret",birthday:a.userInfo.birthday||"",location:a.userInfo.location||"",signature:a.userInfo.signature||""}),X=["/avatars/default1.png","/avatars/default2.png","/avatars/default3.png","/avatars/default4.png","/avatars/default5.png","/avatars/default6.png"],j=(0,l.EW)((()=>{if(!z.value.birthday)return"保密";const e=new Date(z.value.birthday),a=new Date;let t=a.getFullYear()-e.getFullYear();const l=a.getMonth()-e.getMonth();return(l<0||0===l&&a.getDate()<e.getDate())&&t--,t.toString()})),H=e=>e.getTime()>Date.now(),q=(0,l.EW)((()=>a.userInfo.avatar||"https://cube.elemecdn.com/3/7c/3ea6beec64369c2642b92c6726f1epng.png")),B=(0,l.EW)((()=>a.userInfo.level||1)),G=(0,l.EW)((()=>x.completedTasks?.length||0)),J=(0,l.EW)((()=>t.plants?.length||0)),N=(0,s.KR)(!1),Q=(0,s.KR)(!1),Z=(0,s.KR)(null),ee=(0,s.Kh)({currentPassword:"",newPassword:"",confirmPassword:""}),ae={currentPassword:[{required:!0,message:"请输入当前密码",trigger:"blur"}],newPassword:[{required:!0,message:"请输入新密码",trigger:"blur"},{min:6,message:"密码长度不能少于6个字符",trigger:"blur"}],confirmPassword:[{required:!0,message:"请确认新密码",trigger:"blur"},{validator:(e,a,t)=>{a!==ee.newPassword?t(new Error("两次输入的密码不一致")):t()},trigger:"blur"}]},te=e=>{z.value.avatar=e},le=async e=>{try{const a=e.raw.type.startsWith("image/");if(!a)return void d.nk.error("只能上传图片文件！");const t=e.raw.size/1024/1024<2;if(!t)return void d.nk.error("图片大小不能超过2MB！");const l=p.Ks.service({lock:!0,text:"头像上传中...",background:"rgba(0, 0, 0, 0.7)"});try{const a=await v.A.uploadFile(e.raw,"avatars/");console.log("头像上传成功，URL:",a),z.value.avatar=a,d.nk.success("头像上传成功")}finally{l.close()}}catch(a){console.error("上传头像失败:",a),d.nk.error("上传头像失败，请重试")}};(0,l.sV)((async()=>{try{await a.fetchUserInfo(),z.value={username:a.userInfo.username||"",email:a.userInfo.email||"",avatar:a.userInfo.avatar||"",bio:a.userInfo.bio||"",gender:a.userInfo.gender||"secret",birthday:a.userInfo.birthday||"",location:a.userInfo.location||"",signature:a.userInfo.signature||""}}catch(e){console.error("加载用户信息失败:",e),d.nk.error("加载用户信息失败")}}));const se=()=>{M.value=!0},re=()=>{M.value=!1,z.value={username:a.userInfo.username||"",email:a.userInfo.email||"",avatar:a.userInfo.avatar||"",bio:a.userInfo.bio||"",gender:a.userInfo.gender||"secret",birthday:a.userInfo.birthday||"",location:a.userInfo.location||"",signature:a.userInfo.signature||""}},oe=async()=>{A.value=!0;try{await a.updateProfile(z.value),d.nk.success("个人资料更新成功"),M.value=!1}catch(e){console.error("更新个人资料失败:",e),d.nk.error("更新个人资料失败")}finally{A.value=!1}},ne=async()=>{Z.value&&await Z.value.validate((async e=>{if(e){Q.value=!0;try{await a.changePassword({currentPassword:ee.currentPassword,newPassword:ee.newPassword}),d.nk.success("密码修改成功"),N.value=!1}catch(t){console.error("修改密码失败:",t)}finally{Q.value=!1}}}))},ie=()=>{if(M.value)d.nk.info("进入头像编辑模式");else{const e=z.value.avatar||"https://cube.elemecdn.com/3/7c/3ea6beec64369c2642b92c6726f1epng.png";window.open(e,"_blank")}};(0,s.KR)(!1);return(e,t)=>{const o=(0,l.g2)("el-icon"),n=(0,l.g2)("el-button"),i=(0,l.g2)("el-avatar"),c=(0,l.g2)("el-upload"),d=(0,l.g2)("el-popover"),p=(0,l.g2)("el-tag"),v=(0,l.g2)("el-input"),x=(0,l.g2)("el-form-item"),ce=(0,l.g2)("el-option"),ue=(0,l.g2)("el-select"),de=(0,l.g2)("el-date-picker"),pe=(0,l.g2)("el-form"),ve=(0,l.g2)("el-dialog");return(0,l.uX)(),(0,l.CE)("div",f,[(0,l.Lk)("div",k,[(0,l.Lk)("div",m,[t[15]||(t[15]=(0,l.Lk)("h1",{class:"page-title"},"个人资料",-1)),M.value?((0,l.uX)(),(0,l.CE)("div",g,[(0,l.bF)(n,{onClick:re},{default:(0,l.k6)((()=>t[13]||(t[13]=[(0,l.eW)("取消")]))),_:1}),(0,l.bF)(n,{type:"primary",onClick:oe,loading:A.value},{default:(0,l.k6)((()=>t[14]||(t[14]=[(0,l.eW)("保存")]))),_:1},8,["loading"])])):((0,l.uX)(),(0,l.Wv)(n,{key:0,type:"primary",onClick:se},{default:(0,l.k6)((()=>[(0,l.bF)(o,null,{default:(0,l.k6)((()=>[(0,l.bF)((0,s.R1)(u.Edit))])),_:1}),t[12]||(t[12]=(0,l.eW)(" 编辑资料 "))])),_:1}))]),(0,l.Lk)("div",b,[(0,l.Lk)("div",y,[(0,l.Lk)("div",h,[M.value?((0,l.uX)(),(0,l.CE)("div",w,[(0,l.bF)(i,{size:120,src:z.value.avatar||q.value},null,8,["src"]),(0,l.Lk)("div",F,[(0,l.bF)(d,{placement:"bottom",width:300,trigger:"click"},{reference:(0,l.k6)((()=>[(0,l.bF)(n,{type:"primary",circle:""},{default:(0,l.k6)((()=>[(0,l.bF)(o,null,{default:(0,l.k6)((()=>[(0,l.bF)((0,s.R1)(u.Camera))])),_:1})])),_:1})])),default:(0,l.k6)((()=>[(0,l.Lk)("div",_,[(0,l.Lk)("div",I,[t[16]||(t[16]=(0,l.Lk)("h4",null,"默认头像",-1)),(0,l.Lk)("div",V,[((0,l.uX)(),(0,l.CE)(l.FK,null,(0,l.pI)(X,((e,a)=>(0,l.Lk)("div",{key:a,class:"default-avatar-item",onClick:a=>te(e)},[(0,l.bF)(i,{size:50,src:e},null,8,["src"])],8,L))),64))])]),(0,l.Lk)("div",P,[t[18]||(t[18]=(0,l.Lk)("h4",null,"上传头像",-1)),(0,l.bF)(c,{class:"avatar-uploader",action:"#","auto-upload":!1,"show-file-list":!1,"on-change":le,accept:"image/*"},{default:(0,l.k6)((()=>[(0,l.bF)(n,{type:"primary"},{default:(0,l.k6)((()=>[(0,l.bF)(o,null,{default:(0,l.k6)((()=>[(0,l.bF)((0,s.R1)(u.Upload))])),_:1}),t[17]||(t[17]=(0,l.eW)(" 选择图片 "))])),_:1})])),_:1})])])])),_:1})])])):((0,l.uX)(),(0,l.Wv)(i,{key:0,size:120,src:z.value.avatar||q.value,onClick:ie,class:"clickable-avatar"},null,8,["src"])),(0,l.Lk)("h2",W,(0,r.v_)((0,s.R1)(a).userInfo.username),1),(0,l.Lk)("div",C,[(0,l.bF)(p,{type:"success"},{default:(0,l.k6)((()=>[(0,l.eW)("等级 "+(0,r.v_)(B.value),1)])),_:1})])]),(0,l.Lk)("div",S,[(0,l.Lk)("div",T,[(0,l.Lk)("div",$,(0,r.v_)(G.value),1),t[19]||(t[19]=(0,l.Lk)("div",{class:"stat-label"},"已完成任务",-1))]),(0,l.Lk)("div",R,[(0,l.Lk)("div",Y,(0,r.v_)(J.value),1),t[20]||(t[20]=(0,l.Lk)("div",{class:"stat-label"},"植物数量",-1))]),(0,l.Lk)("div",K,[(0,l.Lk)("div",E,(0,r.v_)((0,s.R1)(O).coins),1),t[21]||(t[21]=(0,l.Lk)("div",{class:"stat-label"},"金币",-1))])])]),(0,l.Lk)("div",U,[(0,l.bF)(pe,{model:z.value,"label-position":"top",disabled:!M.value},{default:(0,l.k6)((()=>[(0,l.Lk)("div",D,[t[23]||(t[23]=(0,l.Lk)("h3",{class:"section-title"},"基本信息",-1)),(0,l.bF)(x,{label:"用户名"},{default:(0,l.k6)((()=>[(0,l.bF)(v,{modelValue:z.value.username,"onUpdate:modelValue":t[0]||(t[0]=e=>z.value.username=e),placeholder:"请输入用户名"},null,8,["modelValue"])])),_:1}),(0,l.bF)(x,{label:"邮箱"},{default:(0,l.k6)((()=>[(0,l.bF)(v,{modelValue:z.value.email,"onUpdate:modelValue":t[1]||(t[1]=e=>z.value.email=e),placeholder:"请输入邮箱",disabled:""},null,8,["modelValue"])])),_:1}),(0,l.bF)(x,{label:"性别"},{default:(0,l.k6)((()=>[(0,l.bF)(ue,{modelValue:z.value.gender,"onUpdate:modelValue":t[2]||(t[2]=e=>z.value.gender=e),placeholder:"请选择性别"},{default:(0,l.k6)((()=>[(0,l.bF)(ce,{label:"男",value:"male"}),(0,l.bF)(ce,{label:"女",value:"female"}),(0,l.bF)(ce,{label:"保密",value:"secret"})])),_:1},8,["modelValue"])])),_:1}),(0,l.bF)(x,{label:"生日"},{default:(0,l.k6)((()=>[(0,l.bF)(de,{modelValue:z.value.birthday,"onUpdate:modelValue":t[3]||(t[3]=e=>z.value.birthday=e),type:"date",placeholder:"请选择生日",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD","disabled-date":H,clearable:""},null,8,["modelValue"])])),_:1}),(0,l.bF)(x,{label:"年龄"},{default:(0,l.k6)((()=>[(0,l.bF)(v,{"model-value":j.value,disabled:""},{append:(0,l.k6)((()=>t[22]||(t[22]=[(0,l.eW)("岁")]))),_:1},8,["model-value"])])),_:1}),(0,l.bF)(x,{label:"所在地"},{default:(0,l.k6)((()=>[(0,l.bF)(v,{modelValue:z.value.location,"onUpdate:modelValue":t[4]||(t[4]=e=>z.value.location=e),placeholder:"请输入所在地"},null,8,["modelValue"])])),_:1}),(0,l.bF)(x,{label:"个性签名"},{default:(0,l.k6)((()=>[(0,l.bF)(v,{modelValue:z.value.signature,"onUpdate:modelValue":t[5]||(t[5]=e=>z.value.signature=e),type:"textarea",rows:2,placeholder:"写下你的个性签名..."},null,8,["modelValue"])])),_:1}),(0,l.bF)(x,{label:"个人简介"},{default:(0,l.k6)((()=>[(0,l.bF)(v,{modelValue:z.value.bio,"onUpdate:modelValue":t[6]||(t[6]=e=>z.value.bio=e),type:"textarea",rows:4,placeholder:"介绍一下自己吧..."},null,8,["modelValue"])])),_:1})])])),_:1},8,["model","disabled"])])])]),(0,l.bF)(ve,{modelValue:N.value,"onUpdate:modelValue":t[11]||(t[11]=e=>N.value=e),title:"修改密码",width:"30%"},{footer:(0,l.k6)((()=>[(0,l.bF)(n,{onClick:t[10]||(t[10]=e=>N.value=!1)},{default:(0,l.k6)((()=>t[24]||(t[24]=[(0,l.eW)("取消")]))),_:1}),(0,l.bF)(n,{type:"primary",onClick:ne,loading:Q.value},{default:(0,l.k6)((()=>t[25]||(t[25]=[(0,l.eW)(" 确认修改 ")]))),_:1},8,["loading"])])),default:(0,l.k6)((()=>[(0,l.bF)(pe,{model:ee,"label-width":"120px",rules:ae,ref_key:"passwordFormRef",ref:Z},{default:(0,l.k6)((()=>[(0,l.bF)(x,{label:"当前密码",prop:"currentPassword"},{default:(0,l.k6)((()=>[(0,l.bF)(v,{modelValue:ee.currentPassword,"onUpdate:modelValue":t[7]||(t[7]=e=>ee.currentPassword=e),type:"password","show-password":"",placeholder:"请输入当前密码"},null,8,["modelValue"])])),_:1}),(0,l.bF)(x,{label:"新密码",prop:"newPassword"},{default:(0,l.k6)((()=>[(0,l.bF)(v,{modelValue:ee.newPassword,"onUpdate:modelValue":t[8]||(t[8]=e=>ee.newPassword=e),type:"password","show-password":"",placeholder:"请输入新密码"},null,8,["modelValue"])])),_:1}),(0,l.bF)(x,{label:"确认新密码",prop:"confirmPassword"},{default:(0,l.k6)((()=>[(0,l.bF)(v,{modelValue:ee.confirmPassword,"onUpdate:modelValue":t[9]||(t[9]=e=>ee.confirmPassword=e),type:"password","show-password":"",placeholder:"请再次输入新密码"},null,8,["modelValue"])])),_:1})])),_:1},8,["model"])])),_:1},8,["modelValue"])])}}},O=t(1241);const M=(0,O.A)(x,[["__scopeId","data-v-432d3dd5"]]);var A=M}}]);
//# sourceMappingURL=848.e6781855.js.map