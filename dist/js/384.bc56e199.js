"use strict";(self["webpackChunkzhiyuxinsheng"]=self["webpackChunkzhiyuxinsheng"]||[]).push([[384],{2333:function(e,t,a){a.d(t,{O:function(){return i}});a(4114),a(8111),a(2489),a(116);var n=a(2261),r=a(144),o=a(6768),l=a(3271),s=a(4300),c=a(1219);const i=(0,n.nY)("task",(()=>{const e=(0,r.KR)([]),t=(0,r.KR)([]),a=(0,r.KR)([]),n=(0,r.KR)(!1),i=(0,o.EW)((()=>e.value.filter((e=>!e.completed)))),u=async()=>{try{n.value=!0;const t=await s.WY.getTasks();e.value=t.tasks.filter((e=>!e.completed)),a.value=t.tasks.filter((e=>e.completed))}catch(t){c.nk.error("获取任务列表失败")}finally{n.value=!1}},d=async()=>{try{n.value=!0;const e=await s.WY.getSystemTasks();t.value=e.tasks}catch(e){c.nk.error("获取系统任务失败")}finally{n.value=!1}},k=async t=>{try{const a=await s.WY.createTask({title:t.title,description:t.description||"",deadline:t.deadline||"",important:t.important||!1});e.value.push(a.task),c.nk.success("任务创建成功")}catch(a){c.nk.error("创建任务失败")}},p=async t=>{try{await s.WY.completeTask(t);const n=e.value.find((e=>e._id===t));n&&(a.value.unshift({...n,completed:!0,completedAt:(new Date).toISOString()}),e.value=e.value.filter((e=>e._id!==t)));const r=(0,l.g)();if(r.plants&&r.plants.length>0){const e=r.plants.find((e=>e.isMainPlant));if(e){const t=e._id||e.id;if(t){const e=n&&n.important?50:25;await r.gainExperience(t,e),c.nk.success(`任务已完成，获得 ${e} 点经验值！`)}}}else c.nk.success("任务已完成")}catch(n){c.nk.error("完成任务失败")}},g=async e=>{try{const a=(0,l.g)();if(!a.currentPlant)return c.nk.warning("请先添加一个植物"),!1;const n=await s.WY.completeSystemTask(e),r=t.value.findIndex((t=>t._id===e));if(-1!==r&&(t.value[r].completed=!0),n.rewards)c.nk.success(`完成任务获得 ${n.rewards.experience} 点经验`);else{const e=a.currentPlant._id||a.currentPlant.id;if(e){const t=35;await a.gainExperience(e,t),c.nk.success(`完成系统任务获得 ${t} 点经验值`)}}return!0}catch(a){return 400===a.response?.status?c.nk.warning("今天已经完成过此任务"):c.nk.error("完成系统任务失败"),!1}},h=async t=>{try{if(!t)return void c.nk.error("任务ID无效，无法删除");await s.WY.deleteTask(t),e.value=e.value.filter((e=>e._id!==t)),c.nk.success("任务已删除")}catch(a){console.error("删除任务失败:",a),c.nk.error("删除任务失败")}},v=async e=>{try{if(!e)return void c.nk.error("任务ID无效，无法删除");await s.WY.deleteTask(e),a.value=a.value.filter((t=>t._id!==e)),c.nk.success("任务已删除")}catch(t){console.error("删除任务失败:",t),c.nk.error("删除任务失败")}},m=async t=>{try{const{_id:a,title:n,description:r,deadline:o,important:l}=t,i=await s.WY.updateTask(a,{title:n,description:r,deadline:o,important:l}),u=e.value.findIndex((e=>e._id===a));-1!==u&&(e.value[u]=i.task),c.nk.success("任务已更新")}catch(a){c.nk.error("更新任务失败")}},f=async t=>{const a=e.value.find((e=>e._id===t));a&&await m({...a,important:!a.important})};return{tasks:e,systemTasks:t,completedTasks:a,pendingTasks:i,loading:n,fetchTasks:u,fetchSystemTasks:d,addTask:k,completeTask:p,completeSystemTask:g,removeTask:h,removeCompletedTask:v,updateTask:m,toggleTaskImportance:f}}))},3446:function(e,t,a){a.d(t,{D:function(){return s}});a(8111),a(2489);var n=a(2261),r=a(144),o=(a(3271),a(4300)),l=a(1219);const s=(0,n.nY)("post",(()=>{const e=(0,r.KR)([]),t=(0,r.KR)(!1),a=async(a="all")=>{t.value=!0;try{const t=await o.d_.getPosts(a);return e.value=t.posts,t.posts}catch(n){return console.error("获取帖子失败:",n),l.nk.error("获取帖子列表失败"),[]}finally{t.value=!1}},n=async e=>{try{const t={...e,createdAt:e.createdAt||(new Date).toISOString()};console.log("准备提交到后端的帖子数据:",t);await o.d_.createPost(t);return await a(),!0}catch(t){return console.error("发布失败:",t),l.nk.error("发布失败，请稍后再试"),!1}},s=async(e,t=[],a="")=>await n({content:e,images:t,location:a,type:"thought"}),c=async a=>{t.value=!0;try{return await o.d_.deletePost(a),e.value=e.value.filter((e=>e._id!==a)),l.nk.success("删除成功"),!0}catch(n){return console.error("删除帖子失败:",n),l.nk.error("删除失败，请稍后再试"),!1}finally{t.value=!1}},i=async(e,t)=>{try{const n={...t,createdAt:t.createdAt||(new Date).toISOString()};console.log("更新帖子数据:",n);await o.d_.updatePost(e,n);return await a(),l.nk.success("更新成功"),!0}catch(n){return console.error("更新失败:",n),l.nk.error("更新失败，请稍后再试"),!1}},u=()=>{a()};return u(),{posts:e,loading:t,fetchPosts:a,addPost:s,addCustomPost:n,removePost:c,updatePost:i}}))},9384:function(e,t,a){a.r(t),a.d(t,{default:function(){return I}});var n=a(6768),r=a(4232),o=a(5130);const l={class:"plant-voice-page"},s={class:"container"},c={class:"plant-voice-header card"},i={class:"plant-icon"},u={class:"plant-emoji"},d={class:"plant-info"},k={class:"action-bar card"},p={class:"thoughts-list"},g={key:0,class:"empty-thoughts card"},h={key:1},v={class:"thought-date"},m={class:"thought-content"},f={class:"thought-footer"};function y(e,t,a,y,w,P){const _=(0,n.g2)("ChatLineRound"),T=(0,n.g2)("el-icon"),b=(0,n.g2)("el-button"),L=(0,n.g2)("el-option"),C=(0,n.g2)("el-select"),S=(0,n.g2)("el-empty"),F=(0,n.g2)("Star");return(0,n.uX)(),(0,n.CE)("div",l,[(0,n.Lk)("div",s,[(0,n.Lk)("div",c,[(0,n.Lk)("div",i,[(0,n.Lk)("span",u,(0,r.v_)(y.getPlantEmoji()),1)]),(0,n.Lk)("div",d,[(0,n.Lk)("h2",null,(0,r.v_)(y.plantStore.currentPlant?y.plantStore.currentPlant.name:"尚未添加植物")+"的心声",1),t[1]||(t[1]=(0,n.Lk)("p",{class:"plant-description"}," 从植物的视角看待你的生活，倾听它对你的想法和建议。 ",-1))])]),(0,n.Lk)("div",k,[(0,n.bF)(b,{type:"primary",onClick:y.generateThought,class:"generate-btn",loading:y.loading},{default:(0,n.k6)((()=>[(0,n.bF)(T,null,{default:(0,n.k6)((()=>[(0,n.bF)(_)])),_:1}),t[2]||(t[2]=(0,n.eW)(" 生成新的植物心声 "))])),_:1},8,["onClick","loading"]),(0,n.bF)(C,{modelValue:y.plantMood,"onUpdate:modelValue":t[0]||(t[0]=e=>y.plantMood=e),placeholder:"选择植物心情",onChange:y.updateMood,class:"mood-select"},{default:(0,n.k6)((()=>[(0,n.bF)(L,{label:"开心",value:"happy"},{default:(0,n.k6)((()=>t[3]||(t[3]=[(0,n.Lk)("div",{class:"mood-option"},[(0,n.Lk)("span",{class:"mood-emoji"},"😊"),(0,n.eW)(" 开心 ")],-1)]))),_:1}),(0,n.bF)(L,{label:"一般",value:"neutral"},{default:(0,n.k6)((()=>t[4]||(t[4]=[(0,n.Lk)("div",{class:"mood-option"},[(0,n.Lk)("span",{class:"mood-emoji"},"😐"),(0,n.eW)(" 一般 ")],-1)]))),_:1}),(0,n.bF)(L,{label:"难过",value:"sad"},{default:(0,n.k6)((()=>t[5]||(t[5]=[(0,n.Lk)("div",{class:"mood-option"},[(0,n.Lk)("span",{class:"mood-emoji"},"😢"),(0,n.eW)(" 难过 ")],-1)]))),_:1})])),_:1},8,["modelValue","onChange"])]),(0,n.Lk)("div",p,[y.plantStore.thoughts&&0!==y.plantStore.thoughts.length?((0,n.uX)(),(0,n.CE)("div",h,[(0,n.bF)(o.F,{name:"thought-fade"},{default:(0,n.k6)((()=>[((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(y.plantStore.thoughts,((e,a)=>((0,n.uX)(),(0,n.CE)("div",{key:e.id||e._id||a,class:"thought-card card"},[t[7]||(t[7]=(0,n.Lk)("div",{class:"thought-bubble"},null,-1)),(0,n.Lk)("div",v,(0,r.v_)(y.formatDate(e.timestamp)),1),(0,n.Lk)("div",m,(0,r.v_)(e.content),1),(0,n.Lk)("div",f,[(0,n.bF)(b,{type:"text",size:"small",onClick:t=>y.toggleLikeThought(e),class:(0,r.C4)(["like-btn",{liked:e.liked}])},{default:(0,n.k6)((()=>[(0,n.bF)(T,null,{default:(0,n.k6)((()=>[(0,n.bF)(F)])),_:1}),(0,n.eW)(" "+(0,r.v_)(e.liked?"已收藏":"收藏"),1)])),_:2},1032,["onClick","class"])])])))),128))])),_:1})])):((0,n.uX)(),(0,n.CE)("div",g,[(0,n.bF)(S,{description:"还没有植物心声，点击上方按钮生成吧！"},{default:(0,n.k6)((()=>[(0,n.bF)(b,{type:"primary",onClick:y.generateThought,class:"empty-btn",loading:y.loading},{default:(0,n.k6)((()=>[(0,n.bF)(T,null,{default:(0,n.k6)((()=>[(0,n.bF)(_)])),_:1}),t[6]||(t[6]=(0,n.eW)(" 生成第一条心声 "))])),_:1},8,["onClick","loading"])])),_:1})]))])])])}a(8111),a(1701);var w=a(144),P=a(3271),_=a(2333),T=a(3446),b=a(5796),L=a(7477),C=a(1219),S=a(4300),F={name:"PlantVoicePage",components:{ChatLineRound:L.ChatLineRound,Star:L.Star},setup(){const e=(0,P.g)(),t=(0,_.O)(),a=((0,T.D)(),(0,w.KR)(e.currentPlant?.mood||"neutral")),r=(0,w.KR)(!1),o=(0,w.KR)(!0);(0,n.wB)((()=>e.mainPlant),(async t=>{if(t){e.currentPlant=t,a.value=t.mood||"neutral";try{const a=t._id||t.id;a&&(r.value=!0,await e.fetchPlantThoughts(a),0!==e.thoughts.length||o.value||await l())}catch(n){console.error("获取植物心声失败:",n),C.nk.error("获取植物心声失败")}finally{r.value=!1}}}),{immediate:!0});const l=async()=>{if(!e.currentPlant)return void C.nk.warning("请先在花园中购买一个植物");const n=e.currentPlant._id||e.currentPlant.id;if(!n)return console.error("植物ID无效"),void C.nk.warning("植物信息不完整，请重新选择植物");try{r.value=!0,console.log("开始生成植物心声，植物ID:",n);const o={weather:e.currentPlant.weather||"sunny",timeOfDay:s(),mood:a.value,recentTasks:t.completedTasks.slice(0,3).map((e=>({id:e._id||e.id,title:e.title,completed:!0})))};console.log("生成植物心声的上下文:",o);const l=await e.generatePlantThought(n,o);console.log("生成植物心声的结果:",l),l&&(0,C.nk)({message:"植物有新的心声啦！",type:"success"})}catch(o){console.error("生成植物心声失败",o),C.nk.error("生成植物心声失败")}finally{r.value=!1}},s=()=>{const e=(new Date).getHours();return e>=5&&e<12?"morning":e>=12&&e<18?"afternoon":"evening"},c=async t=>{if(!e.currentPlant)return void C.nk.warning("请先选择一个植物");const n=e.currentPlant._id||e.currentPlant.id;if(!n)return console.error("植物ID无效"),void C.nk.warning("植物信息不完整，请重新选择植物");try{r.value=!0;const o=await e.updatePlant(n,{mood:t});if(o){a.value=t;const e={happy:"植物看起来很开心！",neutral:"植物心情平静",sad:"植物有点难过，需要更多关爱"};(0,C.nk)({type:"sad"===t?"warning":"happy"===t?"success":"info",message:e[t]||"植物心情已更新"})}}catch(o){console.error("更新植物心情失败:",o),C.nk.error("更新植物心情失败，请稍后重试"),a.value=e.currentPlant.mood||"neutral"}finally{r.value=!1}},i=e=>e?(0,b.GP)(new Date(e),"yyyy-MM-dd HH:mm"):"",u=()=>e.currentPlant&&e.currentPlant.emoji||"🌱",d=async t=>{if(!t?.id)return console.error("心声对象无效"),void C.nk.warning("无法操作，心声信息无效");if(!e.currentPlant)return void C.nk.warning("请先选择一个植物");const a=e.currentPlant._id||e.currentPlant.id;if(!a)return console.error("植物ID无效"),void C.nk.warning("植物信息不完整，请重新选择植物");try{r.value=!0,t.liked?(await S.AK.unlikeThought(a,t.id),t.liked=!1,(0,C.nk)({message:"已取消收藏",type:"info"})):(await S.AK.likeThought(a,t.id),t.liked=!0,(0,C.nk)({message:"已收藏此心声",type:"success"}))}catch(n){console.error("操作心声收藏失败:",n),C.nk.error("操作失败，请稍后重试")}finally{r.value=!1}},k=e=>!!e&&!(!e._id&&!e.id);return(0,n.sV)((async()=>{if(e.currentPlant||await e.fetchPlants(),e.currentPlant&&k(e.currentPlant)){const a=e.currentPlant._id||e.currentPlant.id;try{r.value=!0,await e.fetchPlantThoughts(a),0===e.thoughts.length&&o.value&&await l()}catch(t){console.error("获取植物心声失败:",t),C.nk.error("获取植物心声失败")}finally{r.value=!1,o.value=!1}}})),{plantStore:e,plantMood:a,loading:r,generateThought:l,updateMood:c,formatDate:i,getPlantEmoji:u,toggleLikeThought:d}}},D=a(1241);const W=(0,D.A)(F,[["render",y],["__scopeId","data-v-c068cffc"]]);var I=W}}]);
//# sourceMappingURL=384.bc56e199.js.map