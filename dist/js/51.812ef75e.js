"use strict";(self["webpackChunkzhiyuxinsheng"]=self["webpackChunkzhiyuxinsheng"]||[]).push([[51],{51:function(e,a,n){n.r(a),n.d(a,{default:function(){return A}});n(4114),n(8111),n(2489);var l=n(6768),t=n(4232),s=n(144),r=n(5130),u=n(3271),i=n(14),c=n(5796),v=n(2933),o=n(1219),d=n(7477);const k={class:"plant-chat-page"},p={class:"container"},m={class:"plant-chat-header card"},g={class:"plant-avatar"},y={class:"plant-emoji"},h={class:"plant-info"},f={class:"plant-status"},w={class:"status-value"},L={class:"mood-emoji"},_={class:"plant-level"},P={class:"level-badge"},C={class:"clear-chat"},b={class:"message-container card"},K={key:0,class:"empty-conversation"},E={class:"message-avatar"},R={key:0,class:"user-avatar"},X={key:1,class:"plant-message-avatar"},F={class:"message-bubble"},I={class:"message-content"},D={class:"typing-segment"},x={key:0,class:"more-segments-indicator"},T={class:"message-time"},j={key:2,class:"typing-indicator"},z={class:"input-container"},B={key:0,class:"suggestion-chips"},V=["onClick"],W={class:"input-wrapper"},H=50,Q=1e3;var S={__name:"PlantChat",setup(e){const a=(0,u.g)(),n=(0,i.n)(),S=(0,s.KR)(null),U=(0,s.KR)(""),Y=(0,s.KR)(!1),A=(0,s.KR)(!0),G=(0,s.KR)(null),M=(0,s.KR)(""),q=(0,s.KR)([]),J=(0,s.KR)(0),N=(0,s.KR)(null),O=(0,s.KR)(null),Z=(0,s.KR)([]),$=(0,s.KR)(0),ee=(0,l.EW)((()=>n.userInfo.avatar||"https://cube.elemecdn.com/3/7c/3ea6beec64369c2642b92c6726f1epng.png")),ae=["ÊèêÈÜíÊàë‰∏ãÂë®‰∫åÂâç‰∫§ÂæÆÁßØÂàÜ‰Ωú‰∏ö","ÊàëÊúÄËøëÂøÉÊÉÖ‰∏çÂ•ΩÔºå‰Ω†ËÉΩÈô™ÊàëËÅäËÅäÂêóÔºü","‰ªäÂ§©Â§©Ê∞îÁúüÂ•ΩÔºåÊàëÊÉ≥Âá∫ÂéªËµ∞Ëµ∞","Â∏ÆÊàëËÆ∞ÂΩï‰∏Ä‰∏ã‰ªäÂ§©ÁöÑ‰ªªÂä°ÂÆåÊàêÊÉÖÂÜµ"],ne={id:"welcome",sender:"plant",content:"‰Ω†Â•ΩÔºÅÊàëÊòØ‰Ω†ÁöÑÊ§çÁâ©‰ºô‰º¥ÔºåÂæàÈ´òÂÖ¥ËÉΩÂíå‰Ω†ËÅäÂ§©„ÄÇ‰Ω†ÂèØ‰ª•ÈóÆÊàë‰ªª‰ΩïÈóÆÈ¢òÔºåÊàñËÄÖÂàÜ‰∫´‰Ω†ÁöÑÊÉ≥Ê≥ï„ÄÇ",timestamp:new Date},le=(0,l.EW)((()=>a.conversations&&0!==a.conversations.length?a.conversations:[ne])),te=()=>a.currentPlant&&a.currentPlant.emoji||"üå±",se=()=>{if(!a.currentPlant)return"Êú™ÁßçÊ§ç";const e={seedling:"ÂπºËãóÊúü",growing:"ÊàêÈïøÊúü",mature:"ÊàêÁÜüÊúü"};return e[a.currentPlant.state]||"ÊàêÈïø‰∏≠"},re=()=>{if(!a.currentPlant)return"üòê";const e={happy:"üòä",neutral:"üòê",sad:"üò¢"};return e[a.currentPlant.mood]||"üòê"},ue=e=>e?(0,c.GP)(new Date(e),"HH:mm"):"",ie=e=>{!e.shiftKey&&U.value.trim()&&(e.preventDefault(),me())},ce=()=>{v.s.confirm("Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÂØπËØùËÆ∞ÂΩïÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ","ÊèêÁ§∫",{confirmButtonText:"Á°ÆÂÆö",cancelButtonText:"ÂèñÊ∂à",type:"warning"}).then((async()=>{if(!a.currentPlant)return;const e=a.currentPlant._id||a.currentPlant.id;try{pe(),await a.clearConversations(e),a.conversations=[ne],o.nk.success("ÂØπËØùÂ∑≤Ê∏ÖÁ©∫ÔºåÂ∞ÜÂºÄÂßãÊñ∞ÁöÑÂØπËØù")}catch(n){console.error("Ê∏ÖÁ©∫ÂØπËØùÂ§±Ë¥•:",n),o.nk.error("Ê∏ÖÁ©∫ÂØπËØùÂ§±Ë¥•")}})).catch((()=>{}))},ve=e=>e?e.split(/\n\n|\n/).filter((e=>""!==e.trim())):[],oe=e=>{pe(),G.value=e.id,Z.value=ve(e.content),q.value=[],$.value=0,M.value="",J.value=Z.value.length,de()},de=()=>{if($.value>=Z.value.length)return void ke();const e=Z.value[$.value];let a=0;N.value&&clearInterval(N.value),N.value=setInterval((()=>{a<=e.length?(M.value=e.substring(0,a),a++,ye()):(clearInterval(N.value),q.value.push(e),M.value="",J.value--,$.value++,$.value<Z.value.length?O.value=setTimeout(de,Q):ke())}),H)},ke=()=>{N.value&&(clearInterval(N.value),N.value=null),O.value&&(clearTimeout(O.value),O.value=null),G.value=null},pe=()=>{N.value&&(clearInterval(N.value),N.value=null),O.value&&(clearTimeout(O.value),O.value=null),G.value=null},me=async()=>{if(!U.value.trim()||Y.value)return;if(!a.currentPlant)return void o.nk.warning("ËØ∑ÂÖàÂú®Ëä±Âõ≠‰∏≠ÈÄâÊã©‰∏Ä‰∏™Ê§çÁâ©");if(!localStorage.getItem("token"))return void o.nk.warning("ËØ∑ÂÖàÁôªÂΩïÂÜç‰∏éÊ§çÁâ©ÂØπËØù");if(!a.currentPlant._id&&!a.currentPlant.id)return console.error("Ê§çÁâ©IDÊó†Êïà"),void o.nk.warning("Ê§çÁâ©‰ø°ÊÅØ‰∏çÂÆåÊï¥ÔºåËØ∑ÈáçÊñ∞ÈÄâÊã©Ê§çÁâ©");const e=a.currentPlant._id||a.currentPlant.id,n=U.value,t={id:Date.now().toString(),sender:"user",content:n,timestamp:new Date};a.conversations||(a.conversations=[]),a.conversations.push(t),U.value="",Y.value=!0,A.value=!1;try{await ye();const t=await a.sendMessage(e,n,!0);if(!t)throw new Error("ÂèëÈÄÅÊ∂àÊÅØÂ§±Ë¥•");await ye(),await(0,l.dY)(),oe(t)}catch(s){console.error("ÂèëÈÄÅÊ∂àÊÅØÂ§±Ë¥•:",s),o.nk.error("ÂèëÈÄÅÊ∂àÊÅØÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÂÜçËØï")}finally{Y.value=!1}},ge=e=>{U.value=e,me()},ye=async()=>{await(0,l.dY)(),S.value&&(S.value.scrollTop=S.value.scrollHeight)};return(0,l.wB)((()=>a.conversations.length),(async()=>{await ye()})),(0,l.wB)((()=>a.mainPlant),(async e=>{if(e){pe(),a.currentPlant=e;try{const n=e._id||e.id;n&&(Y.value=!0,await a.fetchConversations(n),await ye())}catch(n){console.error("Ëé∑ÂèñÂØπËØùÂéÜÂè≤Â§±Ë¥•:",n),o.nk.info("Ëé∑ÂèñÂØπËØùÂéÜÂè≤Â§±Ë¥•ÔºåËØ∑Á®çÂêéÂÜçËØï")}finally{Y.value=!1}}}),{immediate:!0}),(0,l.sV)((async()=>{if(n.user||await n.fetchUserInfo(),a.currentPlant||await a.fetchPlants(),a.currentPlant){if(!a.currentPlant._id&&!a.currentPlant.id)return console.error("Ê§çÁâ©IDÊó†Êïà"),void o.nk.warning("Ê§çÁâ©‰ø°ÊÅØ‰∏çÂÆåÊï¥ÔºåËØ∑ÈáçÊñ∞ÈÄâÊã©Ê§çÁâ©");const n=a.currentPlant._id||a.currentPlant.id;Y.value=!0;try{await a.fetchConversations(n),a.conversations&&0!==a.conversations.length||(a.conversations=[ne])}catch(e){console.error("Ëé∑ÂèñÂØπËØùÂéÜÂè≤Â§±Ë¥•:",e),o.nk.info("Ëé∑ÂèñÂØπËØùÂéÜÂè≤Â§±Ë¥•ÔºåËØ∑Á®çÂêéÂÜçËØï")}finally{Y.value=!1,await ye()}}return()=>{pe()}})),(e,n)=>{const u=(0,l.g2)("el-icon"),i=(0,l.g2)("el-button"),c=(0,l.g2)("el-empty"),v=(0,l.g2)("el-avatar"),o=(0,l.g2)("el-input");return(0,l.uX)(),(0,l.CE)("div",k,[(0,l.Lk)("div",p,[(0,l.Lk)("div",m,[(0,l.Lk)("div",g,[(0,l.Lk)("span",y,(0,t.v_)(te()),1)]),(0,l.Lk)("div",h,[(0,l.Lk)("h2",null,"‰∏é"+(0,t.v_)((0,s.R1)(a).currentPlant?(0,s.R1)(a).currentPlant.name:"Ê§çÁâ©")+"ÂØπËØù",1),(0,l.Lk)("p",f,[n[1]||(n[1]=(0,l.Lk)("span",{class:"status-label"},"Áä∂ÊÄÅ:",-1)),(0,l.Lk)("span",w,(0,t.v_)(se()),1),(0,l.Lk)("span",L,(0,t.v_)(re()),1)])]),(0,l.Lk)("div",_,[(0,l.Lk)("div",P,"Lv."+(0,t.v_)((0,s.R1)(a).currentPlant?.level||1),1)]),(0,l.Lk)("div",C,[(0,l.bF)(i,{type:"text",onClick:ce,disabled:!le.value||le.value.length<=1},{default:(0,l.k6)((()=>[(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)((0,s.R1)(d.Delete))])),_:1}),n[2]||(n[2]=(0,l.eW)(" Ê∏ÖÁ©∫ÂØπËØù "))])),_:1},8,["disabled"])])]),(0,l.Lk)("div",b,[(0,l.Lk)("div",{class:"messages-list",ref_key:"messagesList",ref:S},[le.value&&0!==le.value.length?((0,l.uX)(!0),(0,l.CE)(l.FK,{key:1},(0,l.pI)(le.value,(e=>((0,l.uX)(),(0,l.CE)("div",{key:e.id,class:(0,t.C4)(["message","user"===e.sender?"user-message":"plant-message"])},[(0,l.Lk)("div",E,["user"===e.sender?((0,l.uX)(),(0,l.CE)("span",R,[(0,l.bF)(v,{size:40,src:ee.value},null,8,["src"])])):((0,l.uX)(),(0,l.CE)("span",X,(0,t.v_)(te()),1))]),(0,l.Lk)("div",F,[(0,l.Lk)("div",I,["user"===e.sender?((0,l.uX)(),(0,l.CE)(l.FK,{key:0},[(0,l.eW)((0,t.v_)(e.content),1)],64)):((0,l.uX)(),(0,l.CE)(l.FK,{key:1},[G.value===e.id?((0,l.uX)(),(0,l.CE)(l.FK,{key:0},[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(q.value,((e,a)=>((0,l.uX)(),(0,l.CE)("div",{key:a,class:"message-segment"},(0,t.v_)(e),1)))),128)),(0,l.Lk)("div",D,(0,t.v_)(M.value),1),J.value>0?((0,l.uX)(),(0,l.CE)("div",x,n[4]||(n[4]=[(0,l.Lk)("div",{class:"dot-flashing"},null,-1)]))):(0,l.Q3)("",!0)],64)):((0,l.uX)(!0),(0,l.CE)(l.FK,{key:1},(0,l.pI)(ve(e.content),((e,a)=>((0,l.uX)(),(0,l.CE)("div",{key:a,class:"message-segment"},(0,t.v_)(e),1)))),128))],64))]),(0,l.Lk)("div",T,(0,t.v_)(ue(e.timestamp)),1)])],2)))),128)):((0,l.uX)(),(0,l.CE)("div",K,[(0,l.bF)(c,{description:"ÊöÇÊó†ÂØπËØùÔºåÂèëÈÄÅÊ∂àÊÅØÂºÄÂßã‰∏éÊ§çÁâ©ËÅäÂ§©Âêß~"},{image:(0,l.k6)((()=>n[3]||(n[3]=[(0,l.Lk)("img",{src:"/images/plant_chat_empty.png",alt:"Á©∫ÂØπËØù",class:"empty-img"},null,-1)]))),_:1})])),Y.value?((0,l.uX)(),(0,l.CE)("div",j,n[5]||(n[5]=[(0,l.Lk)("span",null,null,-1),(0,l.Lk)("span",null,null,-1),(0,l.Lk)("span",null,null,-1)]))):(0,l.Q3)("",!0)],512),(0,l.Lk)("div",z,[A.value?((0,l.uX)(),(0,l.CE)("div",B,[((0,l.uX)(),(0,l.CE)(l.FK,null,(0,l.pI)(ae,((e,a)=>(0,l.Lk)("div",{key:a,class:"suggestion-chip",onClick:a=>ge(e)},(0,t.v_)(e),9,V))),64))])):(0,l.Q3)("",!0),(0,l.Lk)("div",W,[(0,l.bF)(o,{modelValue:U.value,"onUpdate:modelValue":n[0]||(n[0]=e=>U.value=e),type:"textarea",rows:1,autosize:{minRows:1,maxRows:4},placeholder:"ËæìÂÖ•Ê∂àÊÅØ‰∏éÊ§çÁâ©ËÅäÂ§©...",onKeyup:(0,r.jR)(ie,["enter","native"])},null,8,["modelValue"]),(0,l.bF)(i,{type:"primary",class:"send-btn",disabled:!U.value.trim()||Y.value,onClick:me},{default:(0,l.k6)((()=>[(0,l.bF)(u,null,{default:(0,l.k6)((()=>[(0,l.bF)((0,s.R1)(d.Position))])),_:1})])),_:1},8,["disabled"])])])])])])}}},U=n(1241);const Y=(0,U.A)(S,[["__scopeId","data-v-1f9c6d1d"]]);var A=Y}}]);
//# sourceMappingURL=51.812ef75e.js.map