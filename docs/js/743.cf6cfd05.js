"use strict";(self["webpackChunkzhiyuxinsheng"]=self["webpackChunkzhiyuxinsheng"]||[]).push([[743],{503:function(e,a,t){t.d(a,{c:function(){return l}});var s=t(2261);t(4300);const l=(0,s.nY)("currency",{state:()=>({coins:parseInt(localStorage.getItem("coins")||"100"),loading:!1}),actions:{addCoins(e){this.coins+=e,this.saveCoins()},deductCoins(e){return this.coins>=e&&(this.coins-=e,this.saveCoins(),!0)},saveCoins(){localStorage.setItem("coins",this.coins.toString())},resetCoins(){this.coins=100,this.saveCoins()}}})},2333:function(e,a,t){t.d(a,{O:function(){return i}});t(4114),t(8111),t(2489),t(116);var s=t(2261),l=t(144),r=t(6768),n=t(3271),o=t(4300),c=t(1219);const i=(0,s.nY)("task",(()=>{const e=(0,l.KR)([]),a=(0,l.KR)([]),t=(0,l.KR)([]),s=(0,l.KR)(!1),i=(0,r.EW)((()=>e.value.filter((e=>!e.completed)))),u=async()=>{try{s.value=!0;const a=await o.WY.getTasks();e.value=a.tasks.filter((e=>!e.completed)),t.value=a.tasks.filter((e=>e.completed))}catch(a){c.nk.error("获取任务列表失败")}finally{s.value=!1}},d=async()=>{try{s.value=!0;const e=await o.WY.getSystemTasks();a.value=e.tasks}catch(e){c.nk.error("获取系统任务失败")}finally{s.value=!1}},p=async a=>{try{const t=await o.WY.createTask({title:a.title,description:a.description||"",deadline:a.deadline||"",important:a.important||!1});e.value.push(t.task),c.nk.success("任务创建成功")}catch(t){c.nk.error("创建任务失败")}},m=async a=>{try{await o.WY.completeTask(a);const s=e.value.find((e=>e._id===a));s&&(t.value.unshift({...s,completed:!0,completedAt:(new Date).toISOString()}),e.value=e.value.filter((e=>e._id!==a)));const l=(0,n.g)();if(l.plants&&l.plants.length>0){const e=l.plants.find((e=>e.isMainPlant));if(e){const a=e._id||e.id;if(a){const e=s&&s.important?50:25;await l.gainExperience(a,e),c.nk.success(`任务已完成，获得 ${e} 点经验值！`)}}}else c.nk.success("任务已完成")}catch(s){c.nk.error("完成任务失败")}},f=async e=>{try{const t=(0,n.g)();if(!t.currentPlant)return c.nk.warning("请先添加一个植物"),!1;const s=await o.WY.completeSystemTask(e),l=a.value.findIndex((a=>a._id===e));if(-1!==l&&(a.value[l].completed=!0),s.rewards)c.nk.success(`完成任务获得 ${s.rewards.experience} 点经验`);else{const e=t.currentPlant._id||t.currentPlant.id;if(e){const a=35;await t.gainExperience(e,a),c.nk.success(`完成系统任务获得 ${a} 点经验值`)}}return!0}catch(t){return 400===t.response?.status?c.nk.warning("今天已经完成过此任务"):c.nk.error("完成系统任务失败"),!1}},v=async a=>{try{if(!a)return void c.nk.error("任务ID无效，无法删除");await o.WY.deleteTask(a),e.value=e.value.filter((e=>e._id!==a)),c.nk.success("任务已删除")}catch(t){console.error("删除任务失败:",t),c.nk.error("删除任务失败")}},k=async e=>{try{if(!e)return void c.nk.error("任务ID无效，无法删除");await o.WY.deleteTask(e),t.value=t.value.filter((a=>a._id!==e)),c.nk.success("任务已删除")}catch(a){console.error("删除任务失败:",a),c.nk.error("删除任务失败")}},g=async a=>{try{const{_id:t,title:s,description:l,deadline:r,important:n}=a,i=await o.WY.updateTask(t,{title:s,description:l,deadline:r,important:n}),u=e.value.findIndex((e=>e._id===t));-1!==u&&(e.value[u]=i.task),c.nk.success("任务已更新")}catch(t){c.nk.error("更新任务失败")}},b=async a=>{const t=e.value.find((e=>e._id===a));t&&await g({...t,important:!t.important})};return{tasks:e,systemTasks:a,completedTasks:t,pendingTasks:i,loading:s,fetchTasks:u,fetchSystemTasks:d,addTask:p,completeTask:m,completeSystemTask:f,removeTask:v,removeCompletedTask:k,updateTask:g,toggleTaskImportance:b}}))},4743:function(e,a,t){t.r(a),t.d(a,{default:function(){return q}});var s=t(6768),l=t(144),r=t(4232),n=t(14),o=t(3271),c=t(2333),i=t(503),u=t(7477),d=t(1219),p=t(5320),m=t(5011);const f={class:"profile-page"},v={class:"profile-container"},k={class:"page-header"},g={key:1,class:"header-actions"},b={class:"profile-content"},h={class:"profile-sidebar"},y={class:"avatar-container"},w={key:1,class:"avatar-upload"},F={class:"avatar-upload-mask"},_={class:"avatar-options"},I={class:"avatar-section"},L={class:"default-avatars"},V=["onClick"],W={class:"avatar-section"},P={class:"username"},S={class:"user-level"},C={class:"sidebar-stats"},T={class:"stat-item achievement"},R={class:"stat-icon"},$={class:"stat-content"},Y={class:"stat-label"},K={class:"highlight"},U={class:"stat-item companion"},E={class:"stat-icon"},D={class:"stat-content"},x={class:"stat-label"},O={class:"highlight"},M={class:"profile-details"},A={class:"form-section"},z={class:"dialog-footer"};var X={__name:"Profile",setup(e){const a=(0,s.EW)((()=>{if(0===X.plants.length)return 0;const e=X.plants[0];if(!e||!e.createdAt)return 0;const a=new Date(e.createdAt),t=new Date,s=Math.abs(t-a),l=Math.ceil(s/864e5);return l})),t=(0,n.n)(),X=(0,o.g)(),j=(0,c.O)(),H=((0,i.c)(),(0,l.KR)(!1)),q=(0,l.KR)(!1),B=(0,l.KR)({username:t.userInfo.username||"",email:t.userInfo.email||"",avatar:t.userInfo.avatar||"",bio:t.userInfo.bio||"",gender:t.userInfo.gender||"secret",birthday:t.userInfo.birthday||"",location:t.userInfo.location||"",signature:t.userInfo.signature||""}),G=["/avatars/default1.png","/avatars/default2.png","/avatars/default3.png","/avatars/default4.png","/avatars/default5.png","/avatars/default6.png"],J=(0,s.EW)((()=>{if(!B.value.birthday)return"保密";const e=new Date(B.value.birthday),a=new Date;let t=a.getFullYear()-e.getFullYear();const s=a.getMonth()-e.getMonth();return(s<0||0===s&&a.getDate()<e.getDate())&&t--,t.toString()})),N=e=>e.getTime()>Date.now(),Q=(0,s.EW)((()=>t.userInfo.avatar||"https://cube.elemecdn.com/3/7c/3ea6beec64369c2642b92c6726f1epng.png")),Z=(0,s.EW)((()=>t.userInfo.level||1)),ee=(0,s.EW)((()=>j.completedTasks?.length||0)),ae=((0,s.EW)((()=>X.plants?.length||0)),(0,l.KR)(!1)),te=(0,l.KR)(!1),se=(0,l.KR)(null),le=(0,l.Kh)({currentPassword:"",newPassword:"",confirmPassword:""}),re={currentPassword:[{required:!0,message:"请输入当前密码",trigger:"blur"}],newPassword:[{required:!0,message:"请输入新密码",trigger:"blur"},{min:6,message:"密码长度不能少于6个字符",trigger:"blur"}],confirmPassword:[{required:!0,message:"请确认新密码",trigger:"blur"},{validator:(e,a,t)=>{a!==le.newPassword?t(new Error("两次输入的密码不一致")):t()},trigger:"blur"}]},ne=e=>{B.value.avatar=e},oe=async e=>{try{const a=e.raw.type.startsWith("image/");if(!a)return void d.nk.error("只能上传图片文件！");const t=e.raw.size/1024/1024<5;if(!t)return void d.nk.error("图片大小不能超过5MB！");const s=p.Ks.service({lock:!0,text:"头像上传中...",background:"rgba(0, 0, 0, 0.7)"});try{const a=await m.A.uploadFile(e.raw,"avatars/");console.log("头像上传成功，URL:",a),B.value.avatar=a,d.nk.success("头像上传成功")}finally{s.close()}}catch(a){console.error("上传头像失败:",a),d.nk.error("上传头像失败，请重试")}};(0,s.sV)((async()=>{try{await t.fetchUserInfo(),B.value={username:t.userInfo.username||"",email:t.userInfo.email||"",avatar:t.userInfo.avatar||"",bio:t.userInfo.bio||"",gender:t.userInfo.gender||"secret",birthday:t.userInfo.birthday||"",location:t.userInfo.location||"",signature:t.userInfo.signature||""},console.log("用户头像URL:",t.userInfo.avatar)}catch(e){console.error("加载用户信息失败:",e),d.nk.error("加载用户信息失败")}}));const ce=()=>{H.value=!0},ie=()=>{H.value=!1,B.value={username:t.userInfo.username||"",email:t.userInfo.email||"",avatar:t.userInfo.avatar||"",bio:t.userInfo.bio||"",gender:t.userInfo.gender||"secret",birthday:t.userInfo.birthday||"",location:t.userInfo.location||"",signature:t.userInfo.signature||""}},ue=async()=>{q.value=!0;try{const e={...B.value};await t.updateProfile(e),await t.fetchUserInfo(),d.nk.success("个人资料更新成功"),H.value=!1}catch(e){console.error("更新个人资料失败:",e),d.nk.error("更新个人资料失败")}finally{q.value=!1}},de=async()=>{se.value&&await se.value.validate((async e=>{if(e){te.value=!0;try{await t.changePassword({currentPassword:le.currentPassword,newPassword:le.newPassword}),d.nk.success("密码修改成功"),ae.value=!1}catch(a){console.error("修改密码失败:",a)}finally{te.value=!1}}}))},pe=()=>{if(H.value)d.nk.info("进入头像编辑模式");else{const e=B.value.avatar||"https://cube.elemecdn.com/3/7c/3ea6beec64369c2642b92c6726f1epng.png";window.open(e,"_blank")}};(0,l.KR)(!1);return(e,n)=>{const o=(0,s.g2)("el-icon"),c=(0,s.g2)("el-button"),i=(0,s.g2)("el-avatar"),d=(0,s.g2)("el-upload"),p=(0,s.g2)("el-popover"),m=(0,s.g2)("el-tag"),X=(0,s.g2)("el-input"),j=(0,s.g2)("el-form-item"),me=(0,s.g2)("el-option"),fe=(0,s.g2)("el-select"),ve=(0,s.g2)("el-date-picker"),ke=(0,s.g2)("el-form"),ge=(0,s.g2)("el-dialog");return(0,s.uX)(),(0,s.CE)("div",f,[(0,s.Lk)("div",v,[(0,s.Lk)("div",k,[n[15]||(n[15]=(0,s.Lk)("h1",{class:"page-title"},"个人资料",-1)),H.value?((0,s.uX)(),(0,s.CE)("div",g,[(0,s.bF)(c,{onClick:ie},{default:(0,s.k6)((()=>n[13]||(n[13]=[(0,s.eW)("取消")]))),_:1}),(0,s.bF)(c,{type:"primary",onClick:ue,loading:q.value},{default:(0,s.k6)((()=>n[14]||(n[14]=[(0,s.eW)("保存")]))),_:1},8,["loading"])])):((0,s.uX)(),(0,s.Wv)(c,{key:0,type:"primary",onClick:ce},{default:(0,s.k6)((()=>[(0,s.bF)(o,null,{default:(0,s.k6)((()=>[(0,s.bF)((0,l.R1)(u.Edit))])),_:1}),n[12]||(n[12]=(0,s.eW)(" 编辑资料 "))])),_:1}))]),(0,s.Lk)("div",b,[(0,s.Lk)("div",h,[(0,s.Lk)("div",y,[H.value?((0,s.uX)(),(0,s.CE)("div",w,[(0,s.bF)(i,{size:120,src:B.value.avatar||Q.value},null,8,["src"]),(0,s.Lk)("div",F,[(0,s.bF)(p,{placement:"bottom",width:300,trigger:"click"},{reference:(0,s.k6)((()=>[(0,s.bF)(c,{type:"primary",circle:""},{default:(0,s.k6)((()=>[(0,s.bF)(o,null,{default:(0,s.k6)((()=>[(0,s.bF)((0,l.R1)(u.Camera))])),_:1})])),_:1})])),default:(0,s.k6)((()=>[(0,s.Lk)("div",_,[(0,s.Lk)("div",I,[n[16]||(n[16]=(0,s.Lk)("h4",null,"默认头像",-1)),(0,s.Lk)("div",L,[((0,s.uX)(),(0,s.CE)(s.FK,null,(0,s.pI)(G,((e,a)=>(0,s.Lk)("div",{key:a,class:"default-avatar-item",onClick:a=>ne(e)},[(0,s.bF)(i,{size:50,src:e},null,8,["src"])],8,V))),64))])]),(0,s.Lk)("div",W,[n[18]||(n[18]=(0,s.Lk)("h4",null,"上传头像",-1)),(0,s.bF)(d,{class:"avatar-uploader",action:"#","auto-upload":!1,"show-file-list":!1,"on-change":oe,accept:"image/*"},{default:(0,s.k6)((()=>[(0,s.bF)(c,{type:"primary"},{default:(0,s.k6)((()=>[(0,s.bF)(o,null,{default:(0,s.k6)((()=>[(0,s.bF)((0,l.R1)(u.Upload))])),_:1}),n[17]||(n[17]=(0,s.eW)(" 选择图片 "))])),_:1})])),_:1})])])])),_:1})])])):((0,s.uX)(),(0,s.Wv)(i,{key:0,size:120,src:B.value.avatar||Q.value,onClick:pe,class:"clickable-avatar"},null,8,["src"])),(0,s.Lk)("h2",P,(0,r.v_)((0,l.R1)(t).userInfo.username),1),(0,s.Lk)("div",S,[(0,s.bF)(m,{type:"success"},{default:(0,s.k6)((()=>[(0,s.eW)("等级 "+(0,r.v_)(Z.value),1)])),_:1})])]),(0,s.Lk)("div",C,[(0,s.Lk)("div",T,[(0,s.Lk)("div",R,[(0,s.bF)(o,null,{default:(0,s.k6)((()=>[(0,s.bF)((0,l.R1)(u.Trophy))])),_:1})]),(0,s.Lk)("div",$,[(0,s.Lk)("div",Y,[n[19]||(n[19]=(0,s.eW)("一路走来，你已经完成了 ")),(0,s.Lk)("span",K,(0,r.v_)(ee.value),1),n[20]||(n[20]=(0,s.eW)(" 个任务"))])])]),(0,s.Lk)("div",U,[(0,s.Lk)("div",E,[(0,s.bF)(o,null,{default:(0,s.k6)((()=>[(0,s.bF)((0,l.R1)(u.Sunny))])),_:1})]),(0,s.Lk)("div",D,[(0,s.Lk)("div",x,[n[21]||(n[21]=(0,s.eW)("你的植物朋友们，已经陪伴了你 ")),(0,s.Lk)("span",O,(0,r.v_)(a.value),1),n[22]||(n[22]=(0,s.eW)(" 天"))])])])])]),(0,s.Lk)("div",M,[(0,s.bF)(ke,{model:B.value,"label-position":"top",disabled:!H.value,class:"modern-form"},{default:(0,s.k6)((()=>[(0,s.Lk)("div",A,[n[24]||(n[24]=(0,s.Lk)("h3",{class:"section-title"},"基本信息",-1)),(0,s.bF)(j,{label:"用户名",class:"form-item-animated"},{default:(0,s.k6)((()=>[(0,s.bF)(X,{modelValue:B.value.username,"onUpdate:modelValue":n[0]||(n[0]=e=>B.value.username=e),placeholder:"请输入用户名",class:"modern-input"},null,8,["modelValue"])])),_:1}),(0,s.bF)(j,{label:"邮箱",class:"form-item-animated"},{default:(0,s.k6)((()=>[(0,s.bF)(X,{modelValue:B.value.email,"onUpdate:modelValue":n[1]||(n[1]=e=>B.value.email=e),placeholder:"请输入邮箱",disabled:"",class:"modern-input"},null,8,["modelValue"])])),_:1}),(0,s.bF)(j,{label:"性别",class:"form-item-animated"},{default:(0,s.k6)((()=>[(0,s.bF)(fe,{modelValue:B.value.gender,"onUpdate:modelValue":n[2]||(n[2]=e=>B.value.gender=e),placeholder:"请选择性别",class:"modern-select"},{default:(0,s.k6)((()=>[(0,s.bF)(me,{label:"男",value:"male"}),(0,s.bF)(me,{label:"女",value:"female"}),(0,s.bF)(me,{label:"保密",value:"secret"})])),_:1},8,["modelValue"])])),_:1}),(0,s.bF)(j,{label:"生日",class:"form-item-animated"},{default:(0,s.k6)((()=>[(0,s.bF)(ve,{modelValue:B.value.birthday,"onUpdate:modelValue":n[3]||(n[3]=e=>B.value.birthday=e),type:"date",placeholder:"请选择生日",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD","disabled-date":N,clearable:"",class:"modern-date-picker"},null,8,["modelValue"])])),_:1}),(0,s.bF)(j,{label:"年龄",class:"form-item-animated"},{default:(0,s.k6)((()=>[(0,s.bF)(X,{"model-value":J.value,disabled:"",class:"modern-input"},{append:(0,s.k6)((()=>n[23]||(n[23]=[(0,s.eW)("岁")]))),_:1},8,["model-value"])])),_:1}),(0,s.bF)(j,{label:"所在地",class:"form-item-animated"},{default:(0,s.k6)((()=>[(0,s.bF)(X,{modelValue:B.value.location,"onUpdate:modelValue":n[4]||(n[4]=e=>B.value.location=e),placeholder:"请输入所在地",class:"modern-input"},null,8,["modelValue"])])),_:1}),(0,s.bF)(j,{label:"个性签名",class:"form-item-animated"},{default:(0,s.k6)((()=>[(0,s.bF)(X,{modelValue:B.value.signature,"onUpdate:modelValue":n[5]||(n[5]=e=>B.value.signature=e),type:"textarea",rows:2,placeholder:"写下你的个性签名...",class:"modern-textarea"},null,8,["modelValue"])])),_:1}),(0,s.bF)(j,{label:"个人简介",class:"form-item-animated"},{default:(0,s.k6)((()=>[(0,s.bF)(X,{modelValue:B.value.bio,"onUpdate:modelValue":n[6]||(n[6]=e=>B.value.bio=e),type:"textarea",rows:4,placeholder:"介绍一下自己吧...",class:"modern-textarea"},null,8,["modelValue"])])),_:1})])])),_:1},8,["model","disabled"])])])]),(0,s.bF)(ge,{modelValue:ae.value,"onUpdate:modelValue":n[11]||(n[11]=e=>ae.value=e),title:"修改密码",width:"30%","custom-class":"modern-dialog"},{footer:(0,s.k6)((()=>[(0,s.Lk)("div",z,[(0,s.bF)(c,{onClick:n[10]||(n[10]=e=>ae.value=!1),class:"cancel-button"},{default:(0,s.k6)((()=>n[25]||(n[25]=[(0,s.eW)("取消")]))),_:1}),(0,s.bF)(c,{type:"primary",onClick:de,loading:te.value,class:"save-button"},{default:(0,s.k6)((()=>n[26]||(n[26]=[(0,s.eW)(" 确认修改 ")]))),_:1},8,["loading"])])])),default:(0,s.k6)((()=>[(0,s.bF)(ke,{model:le,"label-width":"120px",rules:re,ref_key:"passwordFormRef",ref:se,class:"modern-form"},{default:(0,s.k6)((()=>[(0,s.bF)(j,{label:"当前密码",prop:"currentPassword",class:"form-item-animated"},{default:(0,s.k6)((()=>[(0,s.bF)(X,{modelValue:le.currentPassword,"onUpdate:modelValue":n[7]||(n[7]=e=>le.currentPassword=e),type:"password","show-password":"",placeholder:"请输入当前密码",class:"modern-input"},null,8,["modelValue"])])),_:1}),(0,s.bF)(j,{label:"新密码",prop:"newPassword",class:"form-item-animated"},{default:(0,s.k6)((()=>[(0,s.bF)(X,{modelValue:le.newPassword,"onUpdate:modelValue":n[8]||(n[8]=e=>le.newPassword=e),type:"password","show-password":"",placeholder:"请输入新密码",class:"modern-input"},null,8,["modelValue"])])),_:1}),(0,s.bF)(j,{label:"确认新密码",prop:"confirmPassword",class:"form-item-animated"},{default:(0,s.k6)((()=>[(0,s.bF)(X,{modelValue:le.confirmPassword,"onUpdate:modelValue":n[9]||(n[9]=e=>le.confirmPassword=e),type:"password","show-password":"",placeholder:"请再次输入新密码",class:"modern-input"},null,8,["modelValue"])])),_:1})])),_:1},8,["model"])])),_:1},8,["modelValue"])])}}},j=t(1241);const H=(0,j.A)(X,[["__scopeId","data-v-7ec82c14"]]);var q=H},5011:function(e,a,t){t(8111),t(1701);var s=t(4300),l=t(788),r=t.n(l);const n={getOSSConfig(){return s.Ay.get("/oss/config")},getOSSPolicy(e="posts/"){return s.Ay.get("/oss/policy",{params:{dir:e}})},async uploadFile(e,a="posts/"){try{const t=await this.getOSSPolicy(a),s=t.policy;if(!s)throw new Error("获取上传策略失败");let l=s.host;"object"===typeof l&&(console.error("Host 是一个对象而不是字符串:",l),l=`https://${s.bucket}.${s.region}.aliyuncs.com`),l.startsWith("http")||(l=`https://${l}`);const n=new FormData,o=`${s.key}${e.name.substring(e.name.lastIndexOf("."))}`;n.append("key",o),n.append("OSSAccessKeyId",s.accessKeyId),n.append("policy",s.policyBase64),n.append("signature",s.signature),n.append("success_action_status","200"),n.append("file",e),console.log("正在上传文件到:",l),await r().post(l,n,{headers:{"Content-Type":"multipart/form-data"}});let c=s.cdnHost||l;"object"===typeof c&&(c=l);const i=`${c}/${o}`;return console.log("文件上传成功，URL:",i),i}catch(t){throw console.error("上传文件到OSS失败:",t),t}},async uploadMultipleFiles(e,a="posts/"){if(!e||0===e.length)return[];try{const t=await this.getOSSPolicy(a),s=t.policy;if(!s)throw new Error("获取上传策略失败");let l=s.host;"object"===typeof l&&(console.error("Host 是一个对象而不是字符串:",l),l=`https://${s.bucket}.${s.region}.aliyuncs.com`),l.startsWith("http")||(l=`https://${l}`),console.log("准备批量上传文件到:",l);const n=e.map((async(a,t)=>{try{const n=new FormData,o=`${s.key}-${t}${a.name.substring(a.name.lastIndexOf("."))}`;n.append("key",o),n.append("OSSAccessKeyId",s.accessKeyId),n.append("policy",s.policyBase64),n.append("signature",s.signature),n.append("success_action_status","200"),n.append("file",a),await r().post(l,n,{headers:{"Content-Type":"multipart/form-data"}});let c=s.cdnHost||l;"object"===typeof c&&(c=l);const i=`${c}/${o}`;return console.log(`文件 ${t+1}/${e.length} 上传成功:`,i),i}catch(n){throw console.error(`文件 ${t+1}/${e.length} 上传失败:`,n),n}})),o=await Promise.all(n);return console.log("所有文件上传完成，URL列表:",o),o}catch(t){throw console.error("批量上传文件到OSS失败:",t),t}}};a.A=n}}]);
//# sourceMappingURL=743.cf6cfd05.js.map